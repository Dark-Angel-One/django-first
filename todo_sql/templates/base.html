{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy Notes</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'keep-bg': '#ffffff',
                        'keep-bg-dark': '#202124',
                        'keep-sidebar': '#ffffff',
                        'keep-sidebar-dark': '#202124',
                        'keep-hover': '#f1f3f4',
                        'keep-hover-dark': '#28292c',
                        'keep-yellow': '#fbbc04',
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        body { font-family: 'Roboto', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; font-size: 24px; }
        .material-symbols-outlined.fill-1 { font-variation-settings: 'FILL' 1; }

        /* Fix gap issue in hover menus */
        .group:hover .group-hover\:block {
            display: block;
        }
        /* Invisible bridge for menus */
        .group-hover\:block::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 10px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-card {
            background: rgba(32, 33, 36, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Bento Box Grid */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }
        /* Sidebar transition */
        #sidebar { transition: width 0.3s ease; }
        .sidebar-collapsed { width: 80px; }
        .sidebar-expanded { width: 280px; }

        /* Mobile handling */
        @media (max-width: 768px) {
            .sidebar-expanded { position: absolute; z-index: 50; height: 100%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        }
    </style>
</head>
<body class="bg-keep-bg dark:bg-keep-bg-dark text-gray-800 dark:text-gray-200 min-h-screen flex overflow-hidden transition-colors duration-200">
    <div style="display:none;">{% csrf_token %}</div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar-expanded flex flex-col h-screen border-r border-gray-200 dark:border-gray-700 bg-keep-sidebar dark:bg-keep-sidebar-dark pt-2 pb-4 hidden md:flex">
        <!-- Sidebar Content -->
        <div class="px-3">
             <div class="flex items-center gap-4 pl-3 py-3 mb-2">
                 <!-- Hamburger handled by Topbar, but maybe replicate for visual balance? No. -->
             </div>

             <!-- Nav Items -->
             <nav class="space-y-1">
                 <a href="{% url 'index' %}" class="flex items-center gap-4 px-6 py-3 rounded-r-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark {% if active_tab == 'notes' %}bg-yellow-100 dark:bg-yellow-900/30 text-gray-900 dark:text-gray-100{% endif %}">
                     <span class="material-symbols-outlined {% if active_tab == 'notes' %}fill-1{% endif %}">lightbulb</span>
                     <span class="sidebar-text font-medium">Заметки</span>
                 </a>
                 <a href="{% url 'reminders' %}" class="flex items-center gap-4 px-6 py-3 rounded-r-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark {% if active_tab == 'reminders' %}bg-yellow-100 dark:bg-yellow-900/30 text-gray-900 dark:text-gray-100{% endif %}">
                     <span class="material-symbols-outlined {% if active_tab == 'reminders' %}fill-1{% endif %}">notifications</span>
                     <span class="sidebar-text font-medium">Напоминания</span>
                 </a>

                 <div id="sidebar-labels-container">
                 {% for label in user_labels %}
                 <a href="{% url 'label' label.name %}" data-label-id="{{ label.id }}" class="flex items-center gap-4 px-6 py-3 rounded-r-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark {% if active_label == label.name %}bg-yellow-100 dark:bg-yellow-900/30 text-gray-900 dark:text-gray-100{% endif %}">
                     <span class="material-symbols-outlined {% if active_label == label.name %}fill-1{% endif %}">label</span>
                     <span class="sidebar-text font-medium truncate">{{ label.name }}</span>
                 </a>
                 {% endfor %}
                 </div>

                 <button class="flex items-center gap-4 px-6 py-3 rounded-r-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark w-full text-left" onclick="openLabelModal()">
                     <span class="material-symbols-outlined">edit</span>
                     <span class="sidebar-text font-medium">Изменить ярлыки</span>
                 </button>
                 <a href="{% url 'archive' %}" class="flex items-center gap-4 px-6 py-3 rounded-r-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark {% if active_tab == 'archive' %}bg-yellow-100 dark:bg-yellow-900/30 text-gray-900 dark:text-gray-100{% endif %}">
                     <span class="material-symbols-outlined {% if active_tab == 'archive' %}fill-1{% endif %}">archive</span>
                     <span class="sidebar-text font-medium">Архив</span>
                 </a>
                 <a href="{% url 'trash' %}" class="flex items-center gap-4 px-6 py-3 rounded-r-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark {% if active_tab == 'trash' %}bg-yellow-100 dark:bg-yellow-900/30 text-gray-900 dark:text-gray-100{% endif %}">
                     <span class="material-symbols-outlined {% if active_tab == 'trash' %}fill-1{% endif %}">delete</span>
                     <span class="sidebar-text font-medium">Корзина</span>
                 </a>
             </nav>
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden">

        <!-- Topbar -->
        <header class="h-16 flex items-center justify-between px-4 border-b border-gray-200 dark:border-gray-700 bg-keep-bg dark:bg-keep-bg-dark">
            <div class="flex items-center gap-4">
                <button id="menu-btn" class="p-2 rounded-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <div class="flex items-center gap-2">
                    <img src="https://www.gstatic.com/images/branding/product/1x/keep_2020q4_48dp.png" alt="Logo" class="w-10 h-10">
                    <span class="text-xl text-gray-600 dark:text-gray-300 hidden sm:block">Заметки</span>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="flex-1 max-w-2xl mx-4 hidden md:block">
                 {% block search_bar %}
                 <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="material-symbols-outlined text-gray-500">search</span>
                    </div>
                    <input type="text" id="global-search" class="block w-full pl-12 pr-3 py-3 rounded-lg bg-gray-100 dark:bg-gray-800 border-transparent focus:bg-white dark:focus:bg-gray-700 focus:shadow-md transition-all outline-none placeholder-gray-500" placeholder="Поиск">
                 </div>
                 {% endblock %}
            </div>

            <!-- Right Actions -->
            <div class="flex items-center gap-2">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark" title="Toggle Dark Mode">
                    <span class="material-symbols-outlined">dark_mode</span>
                </button>

                <div class="relative ml-2 group">
                    <button class="flex items-center gap-2 hover:bg-keep-hover dark:hover:bg-keep-hover-dark p-1 rounded-full px-3 py-1">
                         <span class="text-sm font-medium">{{ request.user.username }}</span>
                         <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white text-lg">
                             {{ request.user.username.0|upper }}
                         </div>
                    </button>
                     <!-- Dropdown -->
                     <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 hidden group-hover:block hover:block z-50">
                        <form action="{% url 'logout' %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Выйти</button>
                        </form>
                     </div>
                </div>
            </div>
        </header>

        <!-- Main Content Scrollable Area -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8" id="main-scroll">
            {% block content %}
            {% endblock %}
        </main>
    </div>

    <!-- Label Modal -->
    <div id="label-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex justify-center items-center" onclick="closeLabelModal(event)">
        <div class="bg-white dark:bg-keep-bg-dark rounded-lg shadow-xl w-80 p-4" onclick="event.stopPropagation()">
            <h3 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Изменить ярлыки</h3>

            <div class="flex items-center gap-2 border-b border-gray-200 dark:border-gray-700 pb-2 mb-2">
                <button class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200" onclick="createLabel()">
                    <span class="material-symbols-outlined">add</span>
                </button>
                <input type="text" id="new-label-input" placeholder="Создать ярлык" class="flex-1 bg-transparent outline-none text-gray-800 dark:text-gray-200 placeholder-gray-500" onkeydown="if(event.key==='Enter') createLabel()">
                <button class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200" onclick="document.getElementById('new-label-input').value=''">
                    <span class="material-symbols-outlined text-[18px]">close</span>
                </button>
            </div>

            <div class="max-h-60 overflow-y-auto space-y-2" id="label-list">
                {% for label in user_labels %}
                <div class="flex items-center gap-2 group" data-label-id="{{ label.id }}">
                    <button class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200" onclick="deleteLabel({{ label.id }}, this)">
                         <span class="material-symbols-outlined text-[18px]">delete</span>
                    </button>
                    <span class="flex-1 text-gray-800 dark:text-gray-200 text-sm font-medium cursor-text" onclick="enableLabelRename({{ label.id }}, this)">{{ label.name }}</span>
                    <button class="text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity" onclick="enableLabelRename({{ label.id }}, this.previousElementSibling)">
                        <span class="material-symbols-outlined text-[18px]">edit</span>
                    </button>
                </div>
                {% endfor %}
            </div>

            <div class="flex justify-end mt-4">
                <button class="px-4 py-2 text-sm font-medium text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="handleLabelModalDone()">Готово</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        function getCookie(name) {
            // Try to get from hidden input first (HttpOnly cookie safety)
            const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (tokenInput) return tokenInput.value;

            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Label Logic
        function openLabelModal() { document.getElementById('label-modal').classList.remove('hidden'); }
        function closeLabelModal(e) {
            if(!e || e.target.id === 'label-modal' || !e.target.closest('#label-modal > div')) {
                 document.getElementById('label-modal').classList.add('hidden');
                 // No reload needed anymore
            }
        }

        async function handleLabelModalDone() {
             const input = document.getElementById('new-label-input');
             if(input.value.trim()) {
                 await createLabel();
             }
             closeLabelModal();
        }

        async function createLabel() {
            const input = document.getElementById('new-label-input');
            const name = input.value.trim();
            if(!name) return;

            const res = await fetch('/api/v1/labels/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify({name})
            });

            if(res.ok) {
                input.value = '';
                const label = await res.json();
                addLabelToModalList(label);
                addLabelToSidebar(label);
            }
        }

        function addLabelToModalList(label) {
            const list = document.getElementById('label-list');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 group';
            div.dataset.labelId = label.id;

            // Safe DOM creation
            const delBtn = document.createElement('button');
            delBtn.className = 'text-gray-500 hover:text-gray-800 dark:hover:text-gray-200';
            delBtn.onclick = function() { deleteLabel(label.id, this); };
            delBtn.innerHTML = '<span class="material-symbols-outlined text-[18px]">delete</span>';

            const span = document.createElement('span');
            span.className = 'flex-1 text-gray-800 dark:text-gray-200 text-sm font-medium cursor-text';
            span.onclick = function() { enableLabelRename(label.id, span); };
            span.textContent = label.name;

            const editBtn = document.createElement('button');
            editBtn.className = 'text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity';
            editBtn.onclick = function() { enableLabelRename(label.id, span); };
            editBtn.innerHTML = '<span class="material-symbols-outlined text-[18px]">edit</span>';

            div.appendChild(delBtn);
            div.appendChild(span);
            div.appendChild(editBtn);

            list.prepend(div);
        }

        async function deleteLabel(id, btn) {
             // Optimistic removal from modal
             const row = btn.closest('.group');
             if(row) row.remove();

             removeLabelFromSidebar(id);

             const res = await fetch(`/api/v1/labels/${id}/`, {
                method: 'DELETE',
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            });
            if(!res.ok) {
                 // If failed, we should technically restore it, but for now let's just log error
                 console.error("Failed to delete label");
            }
        }

        function enableLabelRename(id, spanElement) {
            const currentName = spanElement.innerText;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'flex-1 bg-transparent outline-none text-gray-800 dark:text-gray-200 text-sm font-medium border-b border-gray-300 focus:border-blue-500';

            input.onblur = async () => {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    await updateLabelName(id, newName, input, spanElement);
                } else {
                    input.replaceWith(spanElement);
                }
            };

            input.onkeydown = async (e) => {
                if(e.key === 'Enter') {
                    input.blur();
                }
            };

            spanElement.replaceWith(input);
            input.focus();
        }

        async function updateLabelName(id, newName, inputElement, originalSpan) {
            // Optimistic update
            originalSpan.textContent = newName;
            inputElement.replaceWith(originalSpan);
            updateLabelInSidebar(id, newName);

            const res = await fetch(`/api/v1/labels/${id}/`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify({name: newName})
            });

            if(!res.ok) {
                console.error("Failed to rename label");
                // Revert
                // Not implementing full revert logic for renaming for simplicity unless requested
            }
        }

        // --- Sidebar Reactivity ---

        function addLabelToSidebar(label) {
            const container = document.getElementById('sidebar-labels-container');
            const a = document.createElement('a');
            a.href = `/label/${encodeURIComponent(label.name)}/`;
            a.className = 'flex items-center gap-4 px-6 py-3 rounded-r-full hover:bg-keep-hover dark:hover:bg-keep-hover-dark';
            a.dataset.labelId = label.id;

            const icon = document.createElement('span');
            icon.className = 'material-symbols-outlined';
            icon.textContent = 'label';

            const text = document.createElement('span');
            text.className = 'sidebar-text font-medium truncate';
            text.textContent = label.name;

            a.appendChild(icon);
            a.appendChild(text);

            if(document.getElementById('sidebar').classList.contains('sidebar-collapsed')) {
                text.style.display = 'none';
            }
            container.appendChild(a);
        }

        function removeLabelFromSidebar(id) {
            const el = document.querySelector(`#sidebar-labels-container a[data-label-id="${id}"]`);
            if(el) el.remove();
        }

        function updateLabelInSidebar(id, newName) {
            const el = document.querySelector(`#sidebar-labels-container a[data-label-id="${id}"]`);
            if(el) {
                el.href = `/label/${encodeURIComponent(newName)}/`;
                el.querySelector('.sidebar-text').textContent = newName;
            }
        }

        // Theme Logic
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = themeToggleBtn.querySelector('span');

        function updateTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeIcon.textContent = 'light_mode';
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                themeIcon.textContent = 'dark_mode';
            }
        }

        // Init Theme
        const savedTheme = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        updateTheme(savedTheme === 'dark' || (!savedTheme && systemDark));

        themeToggleBtn.addEventListener('click', () => {
            updateTheme(!document.documentElement.classList.contains('dark'));
        });

        // Sidebar Logic
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarTexts = document.querySelectorAll('.sidebar-text');

        menuBtn.addEventListener('click', () => {
            if (window.innerWidth >= 768) {
                // Desktop
                const isExpanded = sidebar.classList.contains('sidebar-expanded');
                if (isExpanded) {
                    sidebar.classList.remove('sidebar-expanded');
                    sidebar.classList.add('sidebar-collapsed');
                    sidebarTexts.forEach(t => t.style.display = 'none');
                } else {
                    sidebar.classList.remove('sidebar-collapsed');
                    sidebar.classList.add('sidebar-expanded');
                    sidebarTexts.forEach(t => t.style.display = 'inline');
                }
            } else {
                // Mobile
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('absolute');
                sidebar.classList.toggle('z-50');
                sidebar.classList.toggle('bg-white');
                sidebar.classList.toggle('h-full');
            }
        });

    </script>
    {% block scripts %}
    {% endblock %}
</body>
</html>
